{% extends 'main/base.html' %}
{% load static %}

{% block title %}Configuraciones | RadProc{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/config.css' %}">
<style>
  .hint { font-size:.85rem; color:#6c757d; }
  .edit-actions { display:flex; gap:.5rem; align-items:center; margin-top:.35rem; }
</style>
{% endblock %}

{% block content %}
<section class="ventana-config">
  <h2 class="mb-4">Configuraciones</h2>

  {% if mensaje %}
    <div class="alert alert-info">{{ mensaje }}</div>
  {% endif %}

  <!-- Selector de tipo -->
  <div class="mb-3">
    <label for="tipo-config" class="form-label">Tipo configuración:</label>
    <select id="tipo-config" name="tipo" class="form-select {{ tipo_seleccionado }}">
      {% for opcion in opciones_tipo %}
        <option value="{{ opcion.valor }}"
                {% if opcion.valor == tipo_seleccionado %}selected{% endif %}
                {% if opcion.disabled %}disabled class="text-muted"{% endif %}>
          {{ opcion.etiqueta }}{% if opcion.disabled %} (bloqueado){% endif %}
        </option>
      {% endfor %}
    </select>
  </div>

  {% if tipo_seleccionado == "spectralon" %}
    <div class="alert alert-warning">
      ⚠️ La edición de Spectralon se realiza como <strong>archivo TXT</strong> en una vista dedicada.
    </div>
    <div class="d-flex justify-content-end gap-2">
      <a href="/editar_spectralon/" class="btn btn-primary">Ir al editor TXT</a>
      <a href="/?tipo=agua" class="btn btn-secondary">Cerrar</a>
    </div>
  {% else %}
    <form action="/guardar_config/" method="post" id="form-config">
      {% csrf_token %}
      <input type="hidden" name="tipo" value="{{ tipo_seleccionado|default:'agua' }}">

      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:28%">Parámetro</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody id="tabla-parametros">
            <tr>
              <td>
                <label for="spectrum" class="mb-0">spectrum</label>
                <div class="hint">Cantidad de espectros por bloque.</div>
              </td>
              <td style="max-width:560px">
                <input type="number" class="form-control" name="spectrum" id="spectrum"
                       value="{{ config.spectrum }}">
              </td>
            </tr>

            <!-- meas_order -->
            <tr>
              <td>
                <label for="meas_order" class="mb-0">meas_order</label>
                <div class="hint">
                  Orden de medición (temporal). Ej.: <code>spectralon, target, cielo</code>.
                </div>
              </td>
              <td>
                <input type="text" class="form-control" name="meas_order" id="meas_order"
                       value='{{ config.meas_order }}' autocomplete="off">
                <div class="edit-actions">
                  <button type="button" class="btn btn-outline-secondary btn-sm btn-edit-list"
                          data-target="meas_order">Editar</button>
                </div>
              </td>
            </tr>

            <!-- target_list -->
            <tr>
              <td>
                <label for="target_list" class="mb-0">target_list</label>
                <div class="hint">
                  Lista de targets (temporal). Ej.: <code>M1, M2, M3</code>.
                </div>
              </td>
              <td>
                <input type="text" class="form-control" name="target_list" id="target_list"
                       value='{{ config.target_list }}' autocomplete="off">
                <div class="edit-actions">
                  <button type="button" class="btn btn-outline-secondary btn-sm btn-edit-list"
                          data-target="target_list">Editar</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <button id="guardar-btn" type="submit" class="btn btn-primary">Guardar</button>
        <a href="/?tipo={{ tipo_seleccionado }}" class="btn btn-secondary">Cerrar</a>
      </div>
    </form>
  {% endif %}
</section>

<!-- Modal editor de listas -->
<div class="modal fade" id="editorListaModal" tabindex="-1" aria-labelledby="editorListaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editorListaLabel" class="modal-title">Editar lista</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="editor-help" class="alert alert-secondary py-2 mb-3"></div>
        <textarea id="editorTextarea" class="form-control" rows="12" spellcheck="false"></textarea>
        <div id="editorFeedback" class="mt-2 small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="btn-aplicar-lista" class="btn btn-primary">Aplicar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/config.js' %}"></script>
{% endblock %}




