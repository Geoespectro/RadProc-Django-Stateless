{% extends 'main/base.html' %}
{% load static %}

{% block title %}Inicio | RadProc{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}

<!-- === Selector de tipo de medici√≥n === -->
<div class="row mb-4">
  <div class="col-md-6">
    <label for="tipo-medicion" class="form-label">Tipo de medici√≥n:</label>
    <select id="tipo-medicion" class="form-select" required>
      <option value="" {% if not tipo_seleccionado %}selected{% endif %} disabled hidden>
        Selecciona un tipo de medici√≥n
      </option>
      <option value="agua" {% if tipo_seleccionado == "agua" %}selected{% endif %}>Agua</option>
      <option value="suelo" {% if tipo_seleccionado == "suelo" %}selected{% endif %}>Suelo</option>
    </select>
  </div>
</div>

<!-- === Formulario para subir y procesar ZIP (+ Spectralon opcional) === -->
<form action="/procesar/" method="post" enctype="multipart/form-data" id="form-datos" class="mb-4">
  {% csrf_token %}
  <input type="hidden" name="tipo_medicion" id="tipo-medicion-hidden" value="{{ tipo_seleccionado }}">

  <!-- ZIP principal -->
  <div class="input-group">
    <input type="file" name="zipfile" accept=".zip" class="form-control" required>
    <button type="submit" class="btn btn-primary" id="btn-procesar">Procesar y descargar</button>
  </div>

  <!-- Mensaje visual debajo del input file -->
  <div class="form-text mt-2" id="nombre-carpeta-datos">
    {% if nombre_zip %}
      <span class="text-success">‚úÖ Datos cargados: {{ nombre_zip }}</span>
      <script>sessionStorage.setItem("datos_cargados","1");</script>
    {% else %}
      <span class="text-muted">Ning√∫n archivo seleccionado</span>
      <script>sessionStorage.removeItem("datos_cargados");</script>
    {% endif %}
  </div>

  <!-- === Spectralon (opcional, s√≥lo para esta ejecuci√≥n) === -->
  <hr class="my-4">
  <div class="row align-items-center g-3">
    <div class="col-md-6">
      <label class="form-label mb-0"><strong>Spectralon de Referencia (opcional):</strong></label>
      <div class="form-text">
        ‚ö†Ô∏è Si adjuntas un Spectralon, se usar√° <u>solo en esta ejecuci√≥n</u>. No se guardar√°.
      </div>
    </div>

    <div class="col-md-6 d-flex justify-content-between align-items-center">
      <span class="text-muted" id="nombre-spectralon">
        {{ nombre_spectralon }}
      </span>

      <!-- Input va DENTRO del form principal -->
      <button type="button" class="btn btn-outline-primary btn-sm m-0" id="btn-cambiar-spectralon">
        Cambiar‚Ä¶
      </button>
      <input type="file"
             id="input-spectralon"
             name="spectralon_txt"
             accept=".txt"
             style="display:none">
    </div>
  </div>
</form>

<!-- === Log de procesamiento y acciones === -->
<div class="position-relative">
  <div class="mb-4">
    <textarea class="form-control mb-3" rows="5" readonly id="log-area">{{ log }}</textarea>

    <div class="d-flex justify-content-between gap-2 flex-wrap">
      <form action="{% url 'limpiar_sesion' %}" method="post" class="m-0" onsubmit="sessionStorage.clear()">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm">üßπ Limpiar</button>
      </form>

      <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-success btn-sm" id="btn-exportar-log">Exportar log</button>
        <!-- ‚ö†Ô∏è Bot√≥n de descargar resultados eliminado: el ZIP se entrega al procesar -->
      </div>
    </div>
  </div>

  <div class="logo-app-wrapper">
    <img src="{% static 'img/radproc_logo.svg' %}" alt="Logo RadProc" class="logo-app">
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/index.js' %}"></script>
<script>
  // === UI helpers ===
  function setProcesando(isOn) {
    const btn = document.getElementById('btn-procesar');
    const form = document.getElementById('form-datos');
    if (!btn || !form) return;
    if (isOn) {
      btn.disabled = true;
      btn.textContent = 'Procesando‚Ä¶';
      form.classList.add('opacity-75');
    } else {
      btn.disabled = false;
      btn.textContent = 'Procesar y descargar';
      form.classList.remove('opacity-75');
    }
  }

  function appendLog(msg) {
    const ta = document.getElementById('log-area');
    if (!ta) return;
    const now = new Date().toLocaleString();
    ta.value = (ta.value ? ta.value + '\\n' : '') + `[${now}] ${msg}`;
    ta.scrollTop = ta.scrollHeight;
  }

  // === Manejo de Spectralon en el mismo form ===
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('btn-cambiar-spectralon');
    const input = document.getElementById('input-spectralon');
    const nombre = document.getElementById('nombre-spectralon');
    const tipoSel = document.getElementById('tipo-medicion');
    const tipoHidden = document.getElementById('tipo-medicion-hidden');

    if (btn && input) {
      btn.addEventListener('click', () => input.click());
    }
    if (input && nombre) {
      input.addEventListener('change', () => {
        const f = input.files && input.files[0];
        if (f) {
          nombre.textContent = `Spectralon seleccionado: ${f.name} (solo esta ejecuci√≥n)`;
          nombre.classList.remove('text-muted');
        } else {
          nombre.textContent = "{{ nombre_spectralon }}";
          nombre.classList.add('text-muted');
        }
      });
    }
    if (tipoSel && tipoHidden) {
      tipoSel.addEventListener('change', () => {
        tipoHidden.value = tipoSel.value || '';
      });
    }
  });

  // === Interceptar submit para usar fetch y detectar fin de procesamiento ===
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('form-datos');
    if (!form) return;

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();

      // Validaci√≥n b√°sica
      const tipoHidden = document.getElementById('tipo-medicion-hidden');
      if (!tipoHidden || !tipoHidden.value) {
        appendLog('‚ö†Ô∏è Selecciona un tipo de medici√≥n (Agua o Suelo).');
        return;
      }

      const fd = new FormData(form);
      setProcesando(true);
      appendLog('‚è≥ Iniciando procesamiento‚Ä¶');

      try {
        const resp = await fetch(form.action, {
          method: 'POST',
          body: fd
          // CSRF no requerido: /procesar/ es csrf_exempt en el backend
        });

        if (!resp.ok) {
          // Intentar extraer texto de error
          const txt = await resp.text().catch(() => '');
          appendLog(`‚ùå Error del servidor (${resp.status}). ${txt || ''}`.trim());
          setProcesando(false);
          return;
        }

        // Recibir ZIP como blob
        const blob = await resp.blob();
        // Nombre sugerido por cabecera o fallback
        const dispo = resp.headers.get('Content-Disposition') || '';
        const m = dispo.match(/filename="([^"]+)"/i);
        const filename = m ? m[1] : 'resultados.zip';

        // Disparar descarga
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        // Log + sonido
        appendLog('‚úÖ Procesamiento completado. Descarga iniciada.');
        if (typeof playDoneSound === 'function') {
          playDoneSound();
        }
      } catch (err) {
        appendLog(`‚ùå Error de red o del cliente: ${err}`);
      } finally {
        setProcesando(false);
      }
    });
  });

  // === Exportar log a archivo .txt ===
  document.addEventListener('DOMContentLoaded', function () {
    const btnExp = document.getElementById('btn-exportar-log');
    const ta = document.getElementById('log-area');
    if (btnExp && ta) {
      btnExp.addEventListener('click', () => {
        const blob = new Blob([ta.value || ''], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'radproc_log.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    }
  });
</script>
{% endblock %}


