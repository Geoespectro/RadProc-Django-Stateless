{% extends 'main/base.html' %}
{% load static %}

{% block title %}Inicio | RadProc{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}

<!-- === Selector de tipo de medici√≥n === -->
<div class="row mb-4">
  <div class="col-md-6">
    <label for="tipo-medicion" class="form-label">Tipo de medici√≥n:</label>
    <select id="tipo-medicion" class="form-select" required>
      <option value="" {% if not tipo_seleccionado %}selected{% endif %} disabled hidden>
        Selecciona un tipo de medici√≥n
      </option>
      <option value="agua" {% if tipo_seleccionado == "agua" %}selected{% endif %}>Agua</option>
      <option value="suelo" {% if tipo_seleccionado == "suelo" %}selected{% endif %}>Suelo</option>
    </select>
  </div>
</div>

<!-- === Formulario para subir y procesar ZIP (+ Spectralon opcional) === -->
<form action="/procesar/" method="post" enctype="multipart/form-data" id="form-datos" class="mb-4">
  {% csrf_token %}
  <input type="hidden" name="tipo_medicion" id="tipo-medicion-hidden" value="{{ tipo_seleccionado }}">

  <!-- ZIP principal -->
  <div class="input-group">
    <input type="file" name="zipfile" accept=".zip" class="form-control" required>
    <button type="submit" class="btn btn-primary">Procesar y descargar</button>
  </div>

  <!-- Mensaje visual debajo del input file -->
  <div class="form-text mt-2" id="nombre-carpeta-datos">
    {% if nombre_zip %}
      <span class="text-success">‚úÖ Datos cargados: {{ nombre_zip }}</span>
      <script>sessionStorage.setItem("datos_cargados","1");</script>
    {% else %}
      <span class="text-muted">Ning√∫n archivo seleccionado</span>
      <script>sessionStorage.removeItem("datos_cargados");</script>
    {% endif %}
  </div>

  <!-- === Spectralon (opcional, s√≥lo para esta ejecuci√≥n) === -->
  <hr class="my-4">
  <div class="row align-items-center g-3">
    <div class="col-md-6">
      <label class="form-label mb-0"><strong>Spectralon de Referencia (opcional):</strong></label>
      <div class="form-text">
        ‚ö†Ô∏è Si adjuntas un Spectralon, se usar√° <u>solo en esta ejecuci√≥n</u>. No se guardar√°.
      </div>
    </div>

    <div class="col-md-6 d-flex justify-content-between align-items-center">
      <span class="text-muted" id="nombre-spectralon">
        {{ nombre_spectralon }}
      </span>

      <!-- Ahora el input va DENTRO del form principal -->
      <button type="button" class="btn btn-outline-primary btn-sm m-0" id="btn-cambiar-spectralon">
        Cambiar‚Ä¶
      </button>
      <input type="file"
             id="input-spectralon"
             name="spectralon_txt"
             accept=".txt"
             style="display:none">
    </div>
  </div>
</form>

<!-- === Log de procesamiento y acciones === -->
<div class="position-relative">
  <div class="mb-4">
    <textarea class="form-control mb-3" rows="5" readonly>{{ log }}</textarea>

    <div class="d-flex justify-content-between gap-2 flex-wrap">
      <form action="{% url 'limpiar_sesion' %}" method="post" class="m-0" onsubmit="sessionStorage.clear()">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm">üßπ Limpiar</button>
      </form>

      <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-success btn-sm">Exportar log</button>
        <!-- ‚ö†Ô∏è El bot√≥n de descargar resultados fue eliminado: el ZIP se entrega al procesar -->
      </div>
    </div>
  </div>

  <div class="logo-app-wrapper">
    <img src="{% static 'img/radproc_logo.svg' %}" alt="Logo RadProc" class="logo-app">
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/index.js' %}"></script>
<script>
  // Integraci√≥n m√≠nima para Spectralon en el mismo form:
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('btn-cambiar-spectralon');
    const input = document.getElementById('input-spectralon');
    const nombre = document.getElementById('nombre-spectralon');

    if (btn && input) {
      btn.addEventListener('click', () => input.click());
    }
    if (input && nombre) {
      input.addEventListener('change', () => {
        const f = input.files && input.files[0];
        if (f) {
          nombre.textContent = `Spectralon seleccionado: ${f.name} (solo esta ejecuci√≥n)`;
          nombre.classList.remove('text-muted');
        } else {
          // Vuelve al texto que renderiz√≥ el backend
          nombre.textContent = "{{ nombre_spectralon }}";
          nombre.classList.add('text-muted');
        }
      });
    }
  });
</script>
{% endblock %}


